<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chi ti·∫øt s·∫£n ph·∫©m - C√† Ph√™ ƒê·∫≠m ƒê√†</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="styles/user.css" />
        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
            .product-detail {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 40px;
                margin: 40px 0;
            }
            .product-gallery {
                position: relative;
            }
            .product-gallery img {
                width: 100%;
                height: 500px;
                object-fit: cover;
                border-radius: 16px;
            }
            .product-info {
                display: grid;
                gap: 20px;
            }
            .product-title {
                font-family: "Playfair Display", serif;
                font-size: 32px;
                margin: 0;
                color: var(--coffee-900);
            }
            .product-meta {
                display: flex;
                gap: 12px;
                align-items: center;
            }
            .product-price {
                font-size: 24px;
                font-weight: 600;
                color: var(--coffee);
            }
            .product-stock {
                color: #22c55e;
                font-weight: 500;
            }
            .quantity-selector {
                display: flex;
                align-items: center;
                gap: 12px;
                margin: 20px 0;
            }
            .quantity-selector button {
                width: 36px;
                height: 36px;
                border: 1px solid #ddd;
                border-radius: 8px;
                background: white;
                font-size: 18px;
                cursor: pointer;
            }
            .quantity-selector input {
                width: 60px;
                height: 36px;
                text-align: center;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            .button-group {
                display: flex;
                gap: 12px;
                margin-top: 20px;
            }

            .add-to-cart, .buy-now {
                flex: 1;
                border: none;
                padding: 14px 28px;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: opacity 0.2s;
            }

            .add-to-cart {
                background: var(--coffee);
                color: white;
            }

            .buy-now {
                background: var(--gold);
                color: var(--coffee-900);
            }

            .add-to-cart:hover, .buy-now:hover {
                opacity: 0.9;
            }
            .product-description {
                margin-top: 20px;
                line-height: 1.6;
            }
            .product-features {
                margin-top: 20px;
            }
            .feature-list {
                display: grid;
                gap: 12px;
                margin: 0;
                padding: 0;
            }
            .feature-list li {
                list-style: none;
                display: flex;
                gap: 8px;
                align-items: baseline;
            }
            .feature-list li::before {
                content: "‚Ä¢";
                color: var(--gold);
            }
            .related-products {
                margin-top: 60px;
            }
            .related-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
                margin-top: 20px;
            }
            @media (max-width: 960px) {
                .product-detail {
                    grid-template-columns: 1fr;
                }
                .related-grid {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
            @media (max-width: 640px) {
                .related-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <header class="header">
            <div class="container nav">
                <div class="brand">
                    <a href="index.html">
                        <img src="https://scontent-hkg4-2.xx.fbcdn.net/v/t1.15752-9/552703956_771855105468883_1116774372539651057_n.png?_nc_cat=111&ccb=1-7&_nc_sid=0024fc&_nc_eui2=AeHOBCj3lX8HaOlEvmrFw3xlBrfZDT56J6MGt9kNPnono-ZY8pwnFeBxIqW3onZN3zta5vYTCGt1khW091oaxsr0&_nc_ohc=gpp9itW4IqcQ7kNvwEoG1Qq&_nc_oc=Admu0eUlmvebDWAO50DQbndetZfv1eoK4Pdnm2Fql2WZTtukjFnDuqMCp5j7orfE930&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-hkg4-2.xx&oh=03_Q7cD3QHC08gLgVHXrZ8zt8znzke_wz-InehjvWetDnfV-WoDKQ&oe=68FBBCA9" alt="Logo C√† Ph√™ ƒê·∫≠m ƒê√†" class="brand-logo">
                        <span class="brand-name">C√† Ph√™ ƒê·∫≠m ƒê√†</span>
                    </a>
                </div>

                <nav class="menu" aria-label="Ch√≠nh">
                    <a href="index.html">Trang ch·ªß</a>
                    <div class="dropdown">
                        <a href="products.html">S·∫£n ph·∫©m</a>
                        <div class="dropdown-content">
                            <a href="products.html?category=t1">Arabica</a>
                            <a href="products.html?category=t2">Robusta</a>
                            <a href="products.html?category=t3">Blend</a>
                        </div>
                    </div>
                    <a href="index.html#ve-chung-toi">Gi·ªõi thi·ªáu</a>
                    <a href="index.html#lien-he">Li√™n h·ªá</a>

                    <!-- Gi·ªè h√†ng -->
                    <a href="cart.html" class="badge" aria-label="Gi·ªè h√†ng">
                        Gi·ªè h√†ng
                        <span id="cart-badge" class="badge-count">0</span>
                    </a>
                </nav>

                <button id="menuBtn" class="mobile-toggle" aria-expanded="false" aria-controls="mobileMenu">
                    Menu
                </button>
            </div>
        </header>

        <!-- Mobile menu -->
        <nav id="mobileMenu" hidden class="mobile-menu">
            <a href="index.html">Trang ch·ªß</a>
            <div class="mobile-dropdown">
                <a href="products.html">S·∫£n ph·∫©m</a>
                <div class="mobile-dropdown-content">
                    <a href="products.html?category=t1">Arabica</a>
                    <a href="products.html?category=t2">Robusta</a>
                    <a href="products.html?category=t3">Blend</a>
                </div>
            </div>
            <a href="index.html#ve-chung-toi">Gi·ªõi thi·ªáu</a>
            <a href="index.html#lien-he">Li√™n h·ªá</a>
        </nav>

        <!-- In-page Cart Drawer -->
        <div id="cartDrawerOverlay" hidden style="position: fixed; inset: 64px 0 0 0; background: rgba(0,0,0,0.5); z-index: 80;"></div>
        <aside id="cartDrawer" hidden aria-labelledby="cart-title" style="position: fixed; top: 64px; right: 0; height: calc(100vh - 64px); width: 420px; max-width: 95vw; background: #fff; color: #111; box-shadow: -10px 0 30px rgba(0,0,0,0.3); z-index: 90; display: flex; flex-direction: column; border-radius: 14px 0 0 14px; overflow: hidden;">
            <header style="display:flex; align-items:center; justify-content: space-between; padding: 16px; border-bottom: 1px solid #eee;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="display:inline-flex; width:24px; height:24px; align-items:center; justify-content:center; color:#c62828;">üõí</span>
                    <h3 id="cart-title" style="margin:0; font-size: 18px;">Gi·ªè h√†ng</h3>
                </div>
                <button id="closeCartBtn" aria-label="ƒê√≥ng gi·ªè h√†ng" style="background: transparent; border: none; font-size: 20px; cursor: pointer;">√ó</button>
            </header>
            <div id="cartItems" style="flex:1; overflow: auto; padding: 12px 16px;"></div>
            <footer style="padding: 16px; border-top: 1px solid #eee; background:#fff;">
                <div style="display:flex; align-items:center; justify-content: space-between; margin-bottom: 12px;">
                    <span style="color:#333;">T·ªïng ti·ªÅn:</span>
                    <strong id="cartSubtotal" style="font-size:16px; color: var(--coffee, #4b3429);">0ƒë</strong>
                </div>
                <div style="display:flex; gap:12px;">
                    <button id="addMoreBtn" style="flex:1; padding: 12px 14px; background: #fff; color:#333; border: 1px solid #ddd; border-radius: 8px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                        <span>Ôºã</span>
                        <span>Th√™m m√≥n</span>
                    </button>
                    <button id="checkoutBtn" style="flex:1; padding: 12px 14px; background: var(--gold); color: var(--coffee-900); border:none; border-radius: 8px; cursor:pointer; font-weight: 600;">Thanh to√°n</button>
                </div>
            </footer>
        </aside>
        <!-- Main content -->
        <main class="container">
            <div id="productDetail">
                <!-- Product detail will be inserted here by JavaScript -->
            </div>

            <!-- Related products -->
            <section class="related-products">
                <h2 class="section-title">S·∫£n ph·∫©m li√™n quan</h2>
                <div class="related-grid" id="relatedProducts">
                    <!-- Related products will be inserted here by JavaScript -->
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer id="lien-he">
            <div class="container foot">
                <div>
                    <h4>C√† Ph√™ ƒê·∫≠m ƒê√†</h4>
                    <p>H·∫°t c√† ph√™ rang xay ch·∫•t l∆∞·ª£ng cao. ƒê·ªìng h√†nh c√πng ly c√† ph√™ ngon m·ªói ng√†y.</p>
                </div>
                <div>
                    <h4>Li√™n h·ªá</h4>
                    <p>Hotline: 0901 234 567<br/>Email: hello@caphedamda.vn</p>
                </div>
                <div>
                    <h4>ƒê·ªãa ch·ªâ</h4>
                    <p>123 Phin Street, Qu·∫≠n Caffeine, TP.HCM</p>
                </div>
            </div>
            <div class="container copyright">
                ¬© 2025 C√† Ph√™ ƒê·∫≠m ƒê√†. All rights reserved.
            </div>
        </footer>

        <script type="module">
            import { Products, Types, getSellPrice, computeStock } from './scripts/db.js';
            // Track current stock levels
            let productStocks = new Map();
            
            // Initialize stock levels
            function updateStockLevels() {
                const stockMap = computeStock();
                productStocks = stockMap;
                return stockMap;
            }
            
            // Get available stock for a product
            function getAvailableStock(productId) {
                return productStocks.get(productId) || 0;
            }
            
            // Check if a product is in stock
            function isInStock(productId, quantity = 1) {
                return getAvailableStock(productId) >= quantity;
            }
            
            function getCart(){ try { return JSON.parse(localStorage.getItem('cart')||'[]'); } catch { return []; } }
            function setCart(c){ localStorage.setItem('cart', JSON.stringify(c)); }
            function formatCurrency(value){ return new Intl.NumberFormat('vi-VN').format(value); }
            function updateCartBadge(){ const b=document.getElementById('cart-badge'); if(b) b.textContent=getCart().length; }
            function openCart(){ window.location.href='cart.html'; }
            function closeCart(){ /* no-op */ }
            function toggleCart(){ window.location.href='cart.html'; }
            function renderCart(){ const c=getCart(); const box=document.getElementById('cartItems'); const sub=document.getElementById('cartSubtotal'); if(!box||!sub) return; if(c.length===0){ box.innerHTML='<p>Gi·ªè h√†ng tr·ªëng.</p>'; sub.textContent='0ƒë'; return;} box.innerHTML=c.map(item=>`<div class="cart-item" data-id="${item.id}" style="padding:12px 0; border-bottom:1px solid #f2f2f2;"><div style="display:flex; align-items:start; justify-content: space-between; gap:10px;"><div style="flex:1; min-width:0;"><div style="font-weight:600;">${item.name}</div><div style="display:flex; align-items:center; gap:6px; color:#888; font-size:12px; margin-top:4px;"><span style=\"color:#999;\">‚úé</span><input class=\"note-input\" type=\"text\" placeholder=\"Kh√¥ng c√≥ ghi ch√∫\" value=\"${item.note||''}\" style=\"flex:1; min-width:0; border:none; border-bottom:1px dashed #e0e0e0; padding:4px 0; outline:none;\" /></div><div style="display:flex; align-items:center; gap:8px; margin-top:8px;"><button class=\"qty-dec\" style=\"width:28px; height:28px; border:1px solid #ddd; background:#fff;\">-</button><input class=\"qty-input\" type=\"number\" min=\"1\" value=\"${item.quantity}\" style=\"width:48px; text-align:center; border:1px solid #ddd; height:28px;\" /><button class=\"qty-inc\" style=\"width:28px; height:28px; border:1px solid #ddd; background:#fff;\">+</button><button class=\"remove-item\" style=\"margin-left:8px; background:#fff; border:1px solid #f2d7d7; color:#c62828; cursor:pointer; height:28px; padding:0 10px; border-radius:6px;\">X√≥a</button></div></div><div style=\"min-width:100px; text-align:right; font-weight:600; color:#c62828;\">${formatCurrency(item.price*item.quantity)}ƒë</div></div></div>`).join(''); const total=c.reduce((s,i)=>s+i.price*i.quantity,0); sub.textContent=`${formatCurrency(total)}ƒë`; box.querySelectorAll('.qty-dec').forEach(b=>b.addEventListener('click',onDec)); box.querySelectorAll('.qty-inc').forEach(b=>b.addEventListener('click',onInc)); box.querySelectorAll('.qty-input').forEach(i=>i.addEventListener('change',onChange)); box.querySelectorAll('.remove-item').forEach(b=>b.addEventListener('click',onRemove)); box.querySelectorAll('.note-input').forEach(inp=>inp.addEventListener('change',onChangeNote)); }
            function onDec(e){ const id=e.target.closest('.cart-item')?.dataset.id; const c=getCart(); const it=c.find(i=>i.id===id); if(!it) return; it.quantity=Math.max(1,it.quantity-1); setCart(c); updateCartBadge(); renderCart(); }
            function onInc(e){ const id=e.target.closest('.cart-item')?.dataset.id; const c=getCart(); const it=c.find(i=>i.id===id); if(!it) return; it.quantity+=1; setCart(c); updateCartBadge(); renderCart(); }
            function onChange(e){ const id=e.target.closest('.cart-item')?.dataset.id; const v=Math.max(1, parseInt(e.target.value||'1',10)); const c=getCart(); const it=c.find(i=>i.id===id); if(!it) return; it.quantity=v; setCart(c); updateCartBadge(); renderCart(); }
            function onRemove(e){ const id=e.target.closest('.cart-item')?.dataset.id; const c=getCart().filter(i=>i.id!==id); setCart(c); updateCartBadge(); renderCart(); }
            function onChangeNote(e){ const id=e.target.closest('.cart-item')?.dataset.id; if(!id) return; const c=getCart(); const it=c.find(i=>i.id===id); if(!it) return; it.note = e.target.value.trim(); setCart(c); }
            
            // Get product ID from URL
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');
            
            if (!productId) {
                window.location.href = 'products.html';
            }

            // Load product details
            function loadProductDetail() {
                const product = Products.list().find(p => p.id === productId);
                if (!product) {
                    window.location.href = 'products.html';
                    return;
                }

                const type = Types.list().find(t => t.id === product.typeId);
                const detail = document.getElementById('productDetail');
                
                detail.innerHTML = `
                    <div class="product-detail">
                        <div class="product-gallery">
                            <img src="${product.image || 'https://via.placeholder.com/600x500?text=No+Image'}" 
                                 alt="${product.name}">
                        </div>
                        <div class="product-info">
                            <div>
                                <h1 class="product-title">${product.name}</h1>
                                <div class="product-meta">
                                    <span class="chip">${type?.name || ''}</span>
                                    <span class="product-price">${formatCurrency(getSellPrice(productId).price)}ƒë</span>
                                </div>
                            </div>
                            
                            <div class="product-description">
                                ${product.desc || 'Kh√¥ng c√≥ m√¥ t·∫£ chi ti·∫øt.'}
                            </div>
                            
                            <div class="product-features">
                                <h3>ƒê·∫∑c ƒëi·ªÉm s·∫£n ph·∫©m</h3>
                                <ul class="feature-list">
                                    <li>Lo·∫°i h·∫°t: ${type?.name || ''}</li>
                                    <li>Kh·ªëi l∆∞·ª£ng: ${getWeight(product.name)}</li>
                                    <li>ƒê·ªô rang: V·ª´a</li>
                                    <li>ƒê√≥ng g√≥i: T√∫i c√≥ van tho√°t kh√≠</li>
                                    <li>B·∫£o qu·∫£n: 12 th√°ng k·ªÉ t·ª´ ng√†y s·∫£n xu·∫•t</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="quantity-selector">
                                    <span>S·ªë l∆∞·ª£ng:</span>
                                    <button type="button" id="decreaseQuantity">-</button>
                                    <input type="number" id="quantity" value="1" min="1" max="99">
                                    <button type="button" id="increaseQuantity">+</button>
                                </div>
                                
                                <div class="button-group">
                                    <button class="add-to-cart" id="addToCart">
                                        Th√™m v√†o gi·ªè h√†ng
                                    </button>
                                    <button class="buy-now" id="buyNow">
                                        Mua ngay
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                setupQuantityControls();
                loadRelatedProducts(product.typeId, product.id);
            }

            // Load related products
            function loadRelatedProducts(typeId, currentId) {
                const related = Products.list()
                    .filter(p => p.typeId === typeId && p.id !== currentId && !p.hidden)
                    .slice(0, 3);

                const container = document.getElementById('relatedProducts');
                container.innerHTML = related.map(product => `
                    <article class="card">
                        <img src="${product.image || 'https://via.placeholder.com/400x300?text=No+Image'}" 
                             alt="${product.name}">
                        <div class="card-body">
                            <span class="chip">${getTypeName(product.typeId)}</span>
                            <div class="spacer"></div>
                            <div class="prod">
                                <div>
                                    <h4>${product.name}</h4>
                                    <div>
                                        <span class="price">${formatCurrency(getSellPrice(product.id).price)}ƒë</span>
                                    </div>
                                </div>
                                <button class="add" data-id="${product.id}" 
                                        data-name="${product.name}" 
                                        data-price="${getSellPrice(product.id).price}">
                                    Th√™m v√†o gi·ªè
                                </button>
                            </div>
                        </div>
                    </article>
                `).join('');
            }

            // Setup quantity controls
            function setupQuantityControls() {
                const quantity = document.getElementById('quantity');
                
                document.getElementById('decreaseQuantity').addEventListener('click', () => {
                    const value = parseInt(quantity.value) || 1;
                    if (value > 1) {
                        quantity.value = value - 1;
                    }
                });
                
                document.getElementById('increaseQuantity').addEventListener('click', () => {
                    const value = parseInt(quantity.value) || 1;
                    if (value < 99) {
                        quantity.value = value + 1;
                    }
                });
                
                document.getElementById('addToCart').addEventListener('click', () => {
                    const qty = parseInt(quantity.value) || 1;
                    addToCart(qty, false);
                });

                document.getElementById('buyNow').addEventListener('click', () => {
                    const qty = parseInt(quantity.value) || 1;
                    addToCart(qty, true);
                });
            }

            // Add to cart functionality
            function addToCart(quantity, redirect = false) {
                const product = Products.list().find(p => p.id === productId);
                if (!product) return;
                const cart = getCart();
                const existing = cart.find(i=>i.id===product.id);
                if(existing){ existing.quantity += quantity; }
                else { cart.push({ id: product.id, name: product.name, price: getSellPrice(product.id).price, quantity }); }
                setCart(cart);
                updateCartBadge();
                renderCart();
                if (!redirect) {
                    const button = document.getElementById('addToCart');
                    const originalText = button.textContent;
                    button.textContent = 'ƒê√£ th√™m v√†o gi·ªè';
                    button.disabled = true;
                    setTimeout(() => { button.textContent = originalText; button.disabled = false; }, 2000);
                } else {
                    openCart();
                }
            }

            // Utility functions
            function getTypeName(typeId) {
                const type = Types.list().find(t => t.id === typeId);
                return type ? type.name : '';
            }

            function getWeight(productName) {
                const match = productName.match(/\d+g/);
                return match ? match[0] : 'N/A';
            }

            // Global events for cart: header link navigates directly

            // Initialize
            loadProductDetail();
            updateCartBadge();
            closeCart();
        </script>
    </body>
</html>